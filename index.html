<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>SwingLab</title>
<link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#060a12">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<style>
:root{--bg:#060a12;--bg2:#0b1018;--card:#111a28;--bdr:rgba(255,255,255,0.05);--g:#22d97f;--gd:rgba(34,217,127,0.08);--cy:#06b6d4;--bl:#3b82f6;--or:#f59e0b;--rd:#ef4444;--pu:#a855f7;--pk:#ec4899;--tx:#eef2f7;--tx2:#8a9bb5;--tx3:#4e6180;--M:'JetBrains Mono',monospace;--S:'Outfit',sans-serif}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:var(--S);background:var(--bg);color:var(--tx);min-height:100vh;padding-top:env(safe-area-inset-top)}
.app{display:flex;flex-direction:column;min-height:100vh}

/* Header */
.hdr{display:flex;align-items:center;justify-content:space-between;padding:0 14px;height:48px;border-bottom:1px solid var(--bdr);background:rgba(6,10,18,.94);backdrop-filter:blur(14px);position:sticky;top:0;z-index:10}
.logo{display:flex;align-items:center;gap:8px}
.logo-i{width:28px;height:28px;background:linear-gradient(135deg,var(--g),var(--cy));border-radius:7px;display:flex;align-items:center;justify-content:center;font-size:13px;box-shadow:0 0 12px rgba(34,217,127,.15)}
.logo-n{font-weight:700;font-size:15px}.logo-n span{color:var(--g)}
.hdr-r{display:flex;align-items:center;gap:8px}
.btn{padding:6px 14px;border-radius:6px;border:1px solid rgba(34,217,127,.3);background:transparent;color:var(--g);font-family:var(--S);font-size:11px;font-weight:500;cursor:pointer;transition:.15s}
.btn:hover{background:var(--gd)}.btn.rd{border-color:rgba(239,68,68,.3);color:var(--rd)}.btn.rd:hover{background:rgba(239,68,68,.06)}
.fcnt{font-family:var(--M);font-size:10px;color:var(--tx3)}
#fi{display:none}

/* Main content */
.main{flex:1;overflow-y:auto;padding:12px;padding-bottom:calc(12px + env(safe-area-inset-bottom));max-width:600px;margin:0 auto;width:100%}
.main::-webkit-scrollbar{width:3px}.main::-webkit-scrollbar-thumb{background:rgba(255,255,255,.06)}

/* Club badge */
.club-badge{display:flex;align-items:center;gap:10px;padding:10px 14px;border-radius:10px;background:linear-gradient(135deg,rgba(34,217,127,.08),rgba(6,182,212,.08));border:1px solid rgba(34,217,127,.2);margin-bottom:10px}
.club-icon{font-size:28px}
.club-info{flex:1}
.club-name{font-family:var(--M);font-size:20px;font-weight:700;color:var(--tx)}
.club-file{font-size:10px;color:var(--tx3);margin-top:1px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}

/* Section */
.sec{margin-bottom:12px}
.sec-t{font-size:9px;font-weight:700;color:var(--tx3);text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px;padding-left:2px}

/* Metrics grid */
.mg{display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px}
.mi{padding:10px 8px;border-radius:8px;background:var(--card);border:1px solid var(--bdr);text-align:center}
.mi-l{font-size:8px;color:var(--tx3);text-transform:uppercase;letter-spacing:.3px;margin-bottom:3px}
.mi-v{font-family:var(--M);font-size:16px;font-weight:600}.mi-u{font-size:8px;color:var(--tx3)}
.cg{color:var(--g)}.cp{color:var(--pu)}.co{color:var(--or)}.cc{color:var(--cy)}.cb{color:var(--bl)}.cr{color:var(--rd)}

/* Charts */
.cpan{padding:10px;border-radius:8px;background:var(--card);border:1px solid var(--bdr);margin-bottom:6px}
.cp-h{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px}
.cp-t{font-size:9px;font-weight:600;color:var(--tx2);text-transform:uppercase;letter-spacing:.3px}
.cp-i{font-family:var(--M);font-size:8px;color:var(--or)}
.cp-c{height:80px;position:relative}
.cp-c canvas{width:100%;height:100%;display:block}
.cp-lg{display:flex;gap:10px;padding-top:4px}
.cp-lg i{display:inline-block;width:7px;height:7px;border-radius:2px;margin-right:3px;vertical-align:middle}
.cp-lg span{font-size:8px;color:var(--tx3)}

/* File list */
.fls{margin-bottom:6px}
.fl-t{font-size:9px;color:var(--tx3);text-transform:uppercase;letter-spacing:.4px;margin-bottom:6px;font-weight:600}
.fl-i{display:flex;align-items:center;gap:8px;padding:10px 12px;cursor:pointer;font-size:11px;color:var(--tx2);border-radius:8px;background:var(--card);border:1px solid var(--bdr);margin-bottom:5px;transition:background .15s}
.fl-i:active{background:rgba(255,255,255,.04)}
.fl-i.act{color:var(--tx);border-color:rgba(34,217,127,.3);background:rgba(34,217,127,.06)}
.fl-d{width:10px;height:10px;border-radius:3px;flex-shrink:0}
.fl-n{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-family:var(--M);font-size:10px}

/* Advice Panel */
.adv-pan{margin-bottom:12px}
.adv-t{font-size:13px;font-weight:700;color:var(--g);text-transform:uppercase;letter-spacing:.5px;margin-bottom:10px;display:flex;align-items:center;gap:6px}
.adv-score{display:flex;align-items:center;gap:14px;margin-bottom:12px;padding:14px;border-radius:10px;background:rgba(34,217,127,.06);border:1px solid rgba(34,217,127,.15)}
.adv-ring{width:64px;height:64px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-family:var(--M);font-size:26px;font-weight:700;border:3px solid var(--g);flex-shrink:0}
.adv-grade{font-size:13px;color:var(--tx2)}
.adv-grade b{display:block;font-size:18px;color:var(--tx);margin-bottom:3px}
.adv-items{display:flex;flex-direction:column;gap:8px}
.adv-item{padding:10px 12px;border-radius:8px;background:var(--card);border:1px solid var(--bdr);cursor:pointer;transition:background .15s}
.adv-item:active{background:rgba(255,255,255,.04)}
.adv-item-h{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px}
.adv-item-n{font-size:13px;font-weight:600;color:var(--tx2)}
.adv-item-s{font-family:var(--M);font-size:14px;font-weight:600}
.adv-bar{height:5px;border-radius:3px;background:rgba(255,255,255,.06);overflow:hidden;margin-bottom:5px}
.adv-bar-f{height:100%;border-radius:3px;transition:width .4s}
.adv-tip{font-size:13px;color:var(--tx3);line-height:1.5}
.adv-detail{max-height:0;overflow:hidden;transition:max-height .3s ease;font-size:13px;color:var(--tx2);line-height:1.6}
.adv-detail.open{max-height:300px;margin-top:8px;padding-top:8px;border-top:1px solid var(--bdr)}
.adv-detail-inner{padding:0 2px}
/* Radar chart */
.radar-wrap{padding:14px;border-radius:10px;background:var(--card);border:1px solid var(--bdr);margin-top:10px;margin-bottom:10px;text-align:center}
.radar-title{font-size:11px;font-weight:600;color:var(--tx3);text-transform:uppercase;letter-spacing:.3px;margin-bottom:8px}
.radar-canvas{width:100%;max-width:300px;margin:0 auto;display:block}

.s-good{color:var(--g)}.s-ok{color:var(--or)}.s-bad{color:var(--rd)}
.ai-btn{width:100%;margin-top:10px;padding:12px;border-radius:8px;border:1px solid rgba(34,217,127,.3);background:rgba(34,217,127,.08);color:var(--g);font-family:var(--S);font-size:12px;font-weight:600;cursor:pointer;transition:.2s}
.ai-btn:hover{background:rgba(34,217,127,.15)}
.ai-btn:disabled{opacity:.5;cursor:wait}
.ai-res{margin-top:8px;padding:12px;border-radius:8px;background:var(--card);border:1px solid var(--bdr);font-size:11px;color:var(--tx2);line-height:1.6;max-height:400px;overflow-y:auto;white-space:pre-wrap}

/* Empty state */
.empty{padding:80px 20px;text-align:center}
.empty .ic{font-size:48px;opacity:.15;margin-bottom:12px}
.empty h3{font-size:15px;font-weight:600;color:var(--tx2);margin-bottom:6px}
.empty p{font-size:12px;color:var(--tx3)}

/* Mobile responsive */
@media(max-width:480px){
  .hdr{padding:0 10px;height:44px}
  .logo-i{width:24px;height:24px;font-size:11px}
  .logo-n{font-size:13px}
  .btn{padding:5px 10px;font-size:10px}
  .main{padding:8px}
  .mg{grid-template-columns:1fr 1fr;gap:5px}
  .mi{padding:8px 6px}
  .mi-v{font-size:14px}
  .mi-l{font-size:7px}
  .cpan{padding:8px}
  .cp-c{height:70px}
  .club-badge{padding:8px 10px;gap:8px}
  .club-icon{font-size:24px}
  .club-name{font-size:17px}
  .adv-score{padding:10px;gap:10px}
  .adv-ring{width:52px;height:52px;font-size:22px}
  .adv-grade b{font-size:16px}
  .adv-grade{font-size:12px}
  .adv-item-n{font-size:12px}
  .adv-item-s{font-size:12px}
  .adv-tip{font-size:12px}
  .adv-detail{font-size:12px}
  .radar-canvas{max-width:260px}
}

@media(max-width:360px){
  .mg{grid-template-columns:1fr 1fr}
  .mi-v{font-size:12px}
  .club-name{font-size:15px}
  .adv-ring{width:46px;height:46px;font-size:20px}
  .radar-canvas{max-width:230px}
}
</style>
</head>
<body>
<div class="app">
<header class="hdr">
  <div class="logo">
    <div class="logo-i">&#9971;</div>
    <div class="logo-n">Swing<span>Lab</span></div>
  </div>
  <div class="hdr-r">
    <button class="btn" onclick="document.getElementById('fi').click()">+ CSV</button>
    <span class="fcnt" id="fcnt"></span>
    <button class="btn rd" id="bcl" style="display:none" onclick="clearAll()">Clear</button>
    <input type="file" id="fi" accept=".csv" multiple>
  </div>
</header>

<div class="main" id="mainContent">
  <!-- Empty state -->
  <div class="empty" id="emp">
    <div class="ic">&#9971;</div>
    <h3>CSVã‚’èª­ã¿è¾¼ã‚€</h3>
    <p>Apple Watchã§è¨˜éŒ²ã—ãŸã‚¹ã‚¤ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æã—ã¾ã™</p>
  </div>

  <!-- Content (hidden until CSV loaded) -->
  <div id="dataContent" style="display:none">

    <!-- Club badge -->
    <div class="club-badge" id="clubBadge">
      <div class="club-icon" id="clubIcon">ğŸŒï¸</div>
      <div class="club-info">
        <div class="club-name" id="clubName">--</div>
        <div class="club-file" id="clubFile"></div>
      </div>
    </div>

    <!-- Metrics -->
    <div class="sec">
      <div class="sec-t">Metrics</div>
      <div class="mg">
        <div class="mi"><div class="mi-l">Max Acc</div><div class="mi-v cg" id="xma">--</div></div>
        <div class="mi"><div class="mi-l">Max Gyro</div><div class="mi-v cp" id="xmg">--</div></div>
        <div class="mi"><div class="mi-l">Duration</div><div class="mi-v co" id="xdu">--</div></div>
        <div class="mi"><div class="mi-l">Samples</div><div class="mi-v cc" id="xsc">--</div></div>
        <div class="mi"><div class="mi-l">Hz</div><div class="mi-v cb" id="xsr">--</div></div>
        <div class="mi"><div class="mi-l">Impact</div><div class="mi-v cr" id="xit">--</div></div>
      </div>
    </div>

    <!-- Charts -->
    <div class="sec">
      <div class="sec-t">Charts</div>
      <div class="cpan">
        <div class="cp-h"><span class="cp-t">Acceleration</span><span class="cp-i" id="i1"></span></div>
        <div class="cp-c"><canvas id="cv1"></canvas></div>
        <div class="cp-lg"><span><i style="background:#22d97f"></i>X</span><span><i style="background:#3b82f6"></i>Y</span><span><i style="background:#f59e0b"></i>Z</span></div>
      </div>
      <div class="cpan">
        <div class="cp-h"><span class="cp-t">Gyroscope</span><span class="cp-i" id="i2"></span></div>
        <div class="cp-c"><canvas id="cv2"></canvas></div>
        <div class="cp-lg"><span><i style="background:#a855f7"></i>X</span><span><i style="background:#ec4899"></i>Y</span><span><i style="background:#06b6d4"></i>Z</span></div>
      </div>
      <div class="cpan">
        <div class="cp-h"><span class="cp-t">Total Magnitude</span><span class="cp-i" id="i3"></span></div>
        <div class="cp-c"><canvas id="cv3"></canvas></div>
        <div class="cp-lg"><span><i style="background:#22d97f"></i>Acc</span><span><i style="background:#a855f7"></i>Gyro</span></div>
      </div>
    </div>

    <!-- Files -->
    <div class="sec">
      <div class="fls" id="fls"></div>
    </div>

    <!-- Swing Analysis -->
    <div class="sec">
      <div class="adv-pan" id="advPan">
        <div class="adv-t">&#9971; Swing Analysis</div>
        <div class="adv-score">
          <div class="adv-ring" id="advRing">--</div>
          <div class="adv-grade"><b id="advGrade">--</b><span id="advSummary"></span></div>
        </div>
        <div class="adv-items" id="advItems"></div>
        <div class="radar-wrap" id="radarWrap" style="display:none">
          <div class="radar-title">Balance</div>
          <canvas class="radar-canvas" id="radarCv"></canvas>
        </div>
        <button class="ai-btn" id="aiBtn" onclick="askAI()">&#x1F916; AIã«è©³ç´°ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’èã</button>
        <div class="ai-res" id="aiRes" style="display:none"></div>
      </div>
    </div>

  </div>
</div>
</div>

<script>
// ===================== DATA =====================
const COLS=[
  {ax:'#22d97f',ay:'#3b82f6',az:'#f59e0b',gx:'#a855f7',gy:'#ec4899',gz:'#06b6d4',ta:'#22d97f',tg:'#a855f7'},
  {ax:'#10b981',ay:'#6366f1',az:'#fb923c',gx:'#c084fc',gy:'#f472b6',gz:'#22d3ee',ta:'#10b981',tg:'#c084fc'},
  {ax:'#34d399',ay:'#818cf8',az:'#fbbf24',gx:'#d8b4fe',gy:'#f9a8d4',gz:'#67e8f9',ta:'#34d399',tg:'#d8b4fe'},
];
let sets=[],aIdx=0;

function parseCSV(t){const ls=t.trim().split('\n');const r=[];for(let i=1;i<ls.length;i++){const c=ls[i].replace(/\r/,'').split(',');if(c.length<7)continue;const ax=+c[1],ay=+c[2],az=+c[3],gx=+c[4],gy=+c[5],gz=+c[6];const ta=c.length>=8?+c[7]:Math.sqrt(ax*ax+ay*ay+az*az);const tg=c.length>=9?+c[8]:Math.sqrt(gx*gx+gy*gy+gz*gz);r.push({ts:+c[0],ax,ay,az,gx,gy,gz,ta,tg})}return r}
function detectImpact(d){let m=0,idx=0;d.forEach((v,i)=>{if(v.ta>m){m=v.ta;idx=i}});return idx}

function detectClub(filename){
  const n=filename.toLowerCase();
  const clubs=[
    {keys:['driver','dr','1w'],name:'Driver',icon:'ğŸªµ'},
    {keys:['3w','3wood','fairway3'],name:'3W',icon:'ğŸªµ'},
    {keys:['5w','5wood','fairway5'],name:'5W',icon:'ğŸªµ'},
    {keys:['7w','7wood'],name:'7W',icon:'ğŸªµ'},
    {keys:['3i','iron3','3iron'],name:'3I',icon:'ğŸŒï¸'},
    {keys:['4i','iron4','4iron'],name:'4I',icon:'ğŸŒï¸'},
    {keys:['5i','iron5','5iron'],name:'5I',icon:'ğŸŒï¸'},
    {keys:['6i','iron6','6iron'],name:'6I',icon:'ğŸŒï¸'},
    {keys:['7i','iron7','7iron'],name:'7I',icon:'ğŸŒï¸'},
    {keys:['8i','iron8','8iron'],name:'8I',icon:'ğŸŒï¸'},
    {keys:['9i','iron9','9iron'],name:'9I',icon:'ğŸŒï¸'},
    {keys:['pw','pitching'],name:'PW',icon:'ğŸŒï¸'},
    {keys:['aw','approach','50','52'],name:'AW',icon:'â›³'},
    {keys:['sw','sand','56'],name:'SW',icon:'â›³'},
    {keys:['lw','lob','58','60'],name:'LW',icon:'â›³'},
    {keys:['pt','putter','putt'],name:'PT',icon:'ğŸŒï¸'},
    {keys:['ut','utility','hybrid','hy'],name:'UT',icon:'ğŸªµ'},
  ];
  for(const c of clubs){if(c.keys.some(k=>n.includes(k)))return c}
  return {keys:[],name:'--',icon:'ğŸŒï¸'};
}

function loadFiles(files){
  Array.from(files).forEach(f=>{const r=new FileReader();r.onload=e=>{
    const data=parseCSV(e.target.result);if(!data.length)return;
    const club=detectClub(f.name);
    sets.push({name:f.name,data,club,mxA:Math.max(...data.map(d=>d.ta),.001),mxG:Math.max(...data.map(d=>d.tg),.001),impIdx:detectImpact(data),col:COLS[sets.length%COLS.length]});
    aIdx=sets.length-1;onDataChange()};r.readAsText(f)});
}
function clearAll(){sets=[];aIdx=0;document.getElementById('emp').style.display='';document.getElementById('dataContent').style.display='none';document.getElementById('bcl').style.display='none';document.getElementById('fcnt').textContent='';document.getElementById('fls').innerHTML='';lastAnalysis=null;updMetrics()}
function onDataChange(){document.getElementById('emp').style.display='none';document.getElementById('dataContent').style.display='';document.getElementById('bcl').style.display='';document.getElementById('fcnt').textContent=sets.length+' file'+(sets.length>1?'s':'');updMetrics();updFileList();drawCharts();renderAdvice()}

function updMetrics(){const s=sets[aIdx];if(!s){['xma','xmg','xdu','xsc','xsr','xit'].forEach(id=>document.getElementById(id).innerHTML='--');document.getElementById('clubName').textContent='--';document.getElementById('clubIcon').textContent='ğŸŒï¸';document.getElementById('clubFile').textContent='';return}
  const d=s.data,dur=d[d.length-1].ts-d[0].ts;
  document.getElementById('clubIcon').textContent=s.club.icon;
  document.getElementById('clubName').textContent=s.club.name;
  document.getElementById('clubFile').textContent=s.name;
  document.getElementById('xma').innerHTML=s.mxA.toFixed(2)+'<span class="mi-u">G</span>';
  document.getElementById('xmg').innerHTML=s.mxG.toFixed(2)+'<span class="mi-u">r/s</span>';
  document.getElementById('xdu').innerHTML=dur.toFixed(2)+'<span class="mi-u">s</span>';
  document.getElementById('xsc').textContent=d.length;
  document.getElementById('xsr').innerHTML=(d.length/dur).toFixed(0)+'<span class="mi-u">Hz</span>';
  document.getElementById('xit').innerHTML=d[s.impIdx].ts.toFixed(3)+'<span class="mi-u">s</span>';
}
function updFileList(){document.getElementById('fls').innerHTML='<div class="fl-t">Files</div>'+sets.map((s,i)=>`<div class="fl-i ${i===aIdx?'act':''}" onclick="switchFile(${i})"><div class="fl-d" style="background:${s.col.ta}"></div><div class="fl-n">${s.name}</div></div>`).join('')}
function switchFile(i){aIdx=i;updMetrics();updFileList();drawCharts();renderAdvice()}

// ===================== CHARTS =====================
function drawCharts(){drawCh('cv1','i1',['ax','ay','az'],'G');drawCh('cv2','i2',['gx','gy','gz'],'r/s');drawCh('cv3','i3',['ta','tg'],'')}
function drawCh(cid,iid,keys,unit){
  const cv=document.getElementById(cid);if(!cv||!sets.length)return;
  const cx=cv.getContext('2d'),pr=devicePixelRatio||1,rr=cv.parentElement.getBoundingClientRect();
  cv.width=rr.width*pr;cv.height=rr.height*pr;cx.scale(pr,pr);
  const w=rr.width,h=rr.height;
  let gMn=Infinity,gMx=-Infinity;
  sets.forEach(s=>keys.forEach(k=>s.data.forEach(d=>{if(d[k]<gMn)gMn=d[k];if(d[k]>gMx)gMx=d[k]})));
  const rng=gMx-gMn||1;
  document.getElementById(iid).textContent=gMx.toFixed(4)+(unit?' '+unit:'');
  cx.clearRect(0,0,w,h);
  cx.strokeStyle='rgba(255,255,255,.03)';cx.lineWidth=.5;
  for(let i=0;i<=4;i++){const y=h*i/4;cx.beginPath();cx.moveTo(0,y);cx.lineTo(w,y);cx.stroke()}
  if(gMn<0){const zy=h-((-gMn)/rng)*h;cx.strokeStyle='rgba(255,255,255,.07)';cx.setLineDash([2,2]);cx.beginPath();cx.moveTo(0,zy);cx.lineTo(w,zy);cx.stroke();cx.setLineDash([])}
  sets.forEach((s,si)=>{const al=sets.length>1?(si===aIdx?1:.2):1;keys.forEach(k=>{cx.strokeStyle=s.col[k];cx.lineWidth=si===aIdx?1.5:.7;cx.globalAlpha=al;cx.beginPath();for(let i=0;i<s.data.length;i++){const x=w*i/(s.data.length-1),y=h-((s.data[i][k]-gMn)/rng)*h;i===0?cx.moveTo(x,y):cx.lineTo(x,y)}cx.stroke()});
    if(si===aIdx){cx.globalAlpha=1;const ix=w*s.impIdx/(s.data.length-1);cx.strokeStyle='rgba(239,68,68,.4)';cx.lineWidth=1;cx.setLineDash([2,2]);cx.beginPath();cx.moveTo(ix,0);cx.lineTo(ix,h);cx.stroke();cx.setLineDash([]);cx.fillStyle='rgba(239,68,68,.6)';cx.font='500 7px var(--M)';cx.fillText('IMPACT',ix+2,8)}
    cx.globalAlpha=1});
}

// File input handler
document.getElementById('fi').addEventListener('change',e=>{if(e.target.files.length)loadFiles(e.target.files);e.target.value=''});
window.addEventListener('resize',()=>{if(sets.length)drawCharts()});

// ===================== SWING ANALYSIS ENGINE =====================
let lastAnalysis=null;

function analyzeSwing(){
  const s=sets[aIdx];if(!s)return null;
  const d=s.data;
  const impIdx=s.impIdx;
  const impTime=d[impIdx].ts;
  const dur=d[d.length-1].ts-d[0].ts;
  
  const takebackTime=impTime-d[0].ts;
  const followTime=d[d.length-1].ts-impTime;
  const tempoRatio=takebackTime/Math.max(followTime,0.01);
  const maxAcc=s.mxA;
  const maxGyro=s.mxG;
  
  let maxGzIdx=0,maxGz=0;
  d.forEach((v,i)=>{const ag=Math.abs(v.gz);if(ag>maxGz){maxGz=ag;maxGzIdx=i}});
  const releaseOffset=(d[maxGzIdx].ts-impTime)*1000;
  
  let totalJerk=0;
  for(let i=1;i<d.length;i++){const dt=d[i].ts-d[i-1].ts;if(dt<=0)continue;totalJerk+=Math.abs(d[i].ta-d[i-1].ta)/dt}
  const avgJerk=totalJerk/(d.length-1);
  
  let postImpAcc=0,postCnt=0;
  for(let i=impIdx;i<Math.min(impIdx+30,d.length);i++){postImpAcc+=d[i].ta;postCnt++}
  const avgPostImp=postCnt?postImpAcc/postCnt:0;
  
  const scores={};
  if(tempoRatio>=2.5&&tempoRatio<=3.5)scores.tempo=90+Math.random()*10;
  else if(tempoRatio>=2&&tempoRatio<=4)scores.tempo=70+Math.random()*10;
  else if(tempoRatio>=1.5&&tempoRatio<=5)scores.tempo=50+Math.random()*10;
  else scores.tempo=30+Math.random()*10;
  
  scores.power=Math.min(100,maxAcc/20*100);
  scores.rotation=Math.min(100,maxGyro/50*100);
  
  if(Math.abs(releaseOffset)<=30)scores.release=90+Math.random()*8;
  else if(Math.abs(releaseOffset)<=60)scores.release=70+Math.random()*10;
  else if(Math.abs(releaseOffset)<=100)scores.release=50+Math.random()*10;
  else scores.release=30+Math.random()*10;
  
  scores.smoothness=Math.max(10,100-avgJerk*0.5);
  scores.followthrough=Math.min(100,avgPostImp/maxAcc*200);
  
  Object.keys(scores).forEach(k=>scores[k]=Math.round(Math.min(100,Math.max(0,scores[k]))));
  const overall=Math.round(Object.values(scores).reduce((a,b)=>a+b,0)/Object.keys(scores).length);
  
  const tips={};
  tips.tempo=tempoRatio<2?'ãƒ†ã‚¤ã‚¯ãƒãƒƒã‚¯ãŒé€Ÿã™ãã¾ã™ã€‚3:1ã®ãƒªã‚ºãƒ ã‚’æ„è­˜ã—ã¾ã—ã‚‡ã†':tempoRatio>4?'ãƒ†ã‚¤ã‚¯ãƒãƒƒã‚¯ãŒé…ã™ãã¾ã™ã€‚ã‚‚ã†å°‘ã—ãƒ†ãƒ³ãƒã‚ˆãæŒ¯ã‚Šã¾ã—ã‚‡ã†':'ãƒ†ãƒ³ãƒã¯è‰¯å¥½ã§ã™ã€‚ã“ã®ãƒªã‚ºãƒ ã‚’ç¶­æŒã—ã¾ã—ã‚‡ã†';
  tips.power=maxAcc<5?'ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆã®åŠ é€ŸãŒå¼±ã„ã§ã™ã€‚ä¸‹åŠèº«ã‹ã‚‰ã®é€£å‹•ã‚’æ„è­˜ã—ã¾ã—ã‚‡ã†':maxAcc<10?'ã¾ãšã¾ãšã®ãƒ‘ãƒ¯ãƒ¼ã§ã™ã€‚è…°ã®å›è»¢ã‚’ã‚‚ã£ã¨ä½¿ã„ã¾ã—ã‚‡ã†':'ãƒ‘ãƒ¯ãƒ•ãƒ«ãªã‚¹ã‚¤ãƒ³ã‚°ã§ã™ï¼';
  tips.rotation=maxGyro<20?'å›è»¢ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚è‚©ã®å›è»¢ã‚’å¤§ããã—ã¾ã—ã‚‡ã†':maxGyro<35?'å›è»¢ã¯å¹³å‡çš„ã§ã™ã€‚ã‚‚ã†å°‘ã—ä½“ã‚’æ»è»¢ã•ã›ã¾ã—ã‚‡ã†':'ååˆ†ãªå›è»¢é€Ÿåº¦ã§ã™ï¼';
  tips.release=releaseOffset<-50?'ãƒªãƒªãƒ¼ã‚¹ãŒæ—©ã™ãã¾ã™ã€‚ãƒ€ã‚¦ãƒ³ã‚¹ã‚¤ãƒ³ã‚°åˆæœŸã§æ‰‹é¦–ã®è§’åº¦ã‚’ä¿ã¡ã¾ã—ã‚‡ã†':releaseOffset>50?'ãƒªãƒªãƒ¼ã‚¹ãŒé…ã™ãã¾ã™ã€‚ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆç›´å‰ã§è§£æ”¾ã—ã¾ã—ã‚‡ã†':'ãƒªãƒªãƒ¼ã‚¹ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã¯è‰¯å¥½ã§ã™ï¼';
  tips.smoothness=scores.smoothness<50?'ã‚¹ã‚¤ãƒ³ã‚°ã«ãã“ã¡ãªã•ãŒã‚ã‚Šã¾ã™ã€‚åŠ›ã¾ãšãƒªãƒ©ãƒƒã‚¯ã‚¹ã—ã¦æŒ¯ã‚Šã¾ã—ã‚‡ã†':scores.smoothness<75?'æ¦‚ã­ã‚¹ãƒ ãƒ¼ã‚ºã§ã™ãŒã€åˆ‡ã‚Šè¿”ã—ã‚’ã‚‚ã†å°‘ã—æ»‘ã‚‰ã‹ã«':'ã¨ã¦ã‚‚æ»‘ã‚‰ã‹ãªã‚¹ã‚¤ãƒ³ã‚°ã§ã™ï¼';
  tips.followthrough=scores.followthrough<50?'ãƒ•ã‚©ãƒ­ãƒ¼ã‚¹ãƒ«ãƒ¼ãŒå°ã•ã„ã§ã™ã€‚æŒ¯ã‚ŠæŠœãã“ã¨ã‚’æ„è­˜ã—ã¾ã—ã‚‡ã†':'ã—ã£ã‹ã‚ŠæŒ¯ã‚ŠæŠœã‘ã¦ã„ã¾ã™ï¼';
  
  // Detailed advice per item (shown on click)
  const details={};
  details.tempo=tempoRatio<2
    ?`ãƒ†ãƒ³ãƒæ¯”: ${tempoRatio.toFixed(1)}:1ï¼ˆç†æƒ³ã¯3:1ï¼‰\n\nãƒ†ã‚¤ã‚¯ãƒãƒƒã‚¯ã«ååˆ†ãªæ™‚é–“ã‚’ã‹ã‘ã¦ã„ã¾ã›ã‚“ã€‚æ€¥ã„ã§æŒ¯ã‚‹ã¨ä½“ã®å›è»¢ãŒæµ…ããªã‚Šã€æ‰‹æ‰“ã¡ã«ãªã‚Šã‚„ã™ã„ã§ã™ã€‚\n\nã€ç·´ç¿’æ³•ã€‘ãƒ¡ãƒˆãƒ­ãƒãƒ¼ãƒ ã‚’60BPMã«è¨­å®šã—ã€1æ‹ç›®ã§ãƒ†ã‚¤ã‚¯ãƒãƒƒã‚¯é–‹å§‹ã€3æ‹ç›®ã§ãƒˆãƒƒãƒ—ã€4æ‹ç›®ã§ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆã®ãƒªã‚ºãƒ ã‚’ç¹°ã‚Šè¿”ã—ã¾ã—ã‚‡ã†ã€‚`
    :tempoRatio>4
    ?`ãƒ†ãƒ³ãƒæ¯”: ${tempoRatio.toFixed(1)}:1ï¼ˆç†æƒ³ã¯3:1ï¼‰\n\nãƒ†ã‚¤ã‚¯ãƒãƒƒã‚¯ã«æ™‚é–“ãŒã‹ã‹ã‚Šã™ãã¦ã„ã¾ã™ã€‚ãƒªã‚ºãƒ ãŒå´©ã‚Œã€ãƒ€ã‚¦ãƒ³ã‚¹ã‚¤ãƒ³ã‚°ã§åŠ›ã¿ãŒç”Ÿã˜ã‚„ã™ããªã‚Šã¾ã™ã€‚\n\nã€ç·´ç¿’æ³•ã€‘ç´ æŒ¯ã‚Šã§ã€Œã‚¤ãƒãƒ»ãƒ‹ãƒ»ã‚µãƒ³ã€ã®ãƒªã‚ºãƒ ã‚’å£ã«å‡ºã—ãªãŒã‚‰æŒ¯ã‚Šã¾ã—ã‚‡ã†ã€‚ã€Œã‚µãƒ³ã€ã§ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆã§ã™ã€‚`
    :`ãƒ†ãƒ³ãƒæ¯”: ${tempoRatio.toFixed(1)}:1ï¼ˆç†æƒ³ã¯3:1ï¼‰\n\nãƒ—ãƒ­ã®å¤šããŒ2.5ã€œ3.5:1ã®ãƒ†ãƒ³ãƒæ¯”ã§ã™ã€‚ã“ã®ãƒªã‚ºãƒ ã‚’ä½“ã«è¦šãˆã•ã›ã¾ã—ã‚‡ã†ã€‚\n\nã€ãƒã‚¤ãƒ³ãƒˆã€‘èª¿å­ãŒæ‚ªã„æ™‚ã“ããƒ†ãƒ³ãƒã‚’æ„è­˜ã€‚ãƒªã‚ºãƒ ãŒå®‰å®šã™ã‚‹ã¨ã‚·ãƒ§ãƒƒãƒˆã®å†ç¾æ€§ãŒä¸ŠãŒã‚Šã¾ã™ã€‚`;

  details.power=maxAcc<5
    ?`æœ€å¤§åŠ é€Ÿåº¦: ${maxAcc.toFixed(1)}G\n\nåœ°é¢ååŠ›ã¨ä½“ã®å›è»¢ã‚’ä½¿ãˆã¦ã„ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚è…•ã®åŠ›ã ã‘ã§ã¯å¤§ããªåŠ é€Ÿã¯ç”Ÿã¾ã‚Œã¾ã›ã‚“ã€‚\n\nã€ç·´ç¿’æ³•ã€‘\n1. ã‚¹ãƒ†ãƒƒãƒ—ãƒ‰ãƒªãƒ«: å·¦è¶³ã‚’è¸ã¿è¾¼ã‚“ã§ã‹ã‚‰ãƒ€ã‚¦ãƒ³ã‚¹ã‚¤ãƒ³ã‚°\n2. ãƒ¡ãƒ‡ã‚£ã‚·ãƒ³ãƒœãƒ¼ãƒ«æŠ•ã’: ä½“å…¨ä½“ã®é€£å‹•ã‚’ä½“æ„Ÿ\n3. ãƒãƒ¼ãƒ•ã‚¹ã‚¤ãƒ³ã‚°ã‹ã‚‰å¾ã€…ã«ãƒ•ãƒ«ã‚¹ã‚¤ãƒ³ã‚°ã¸`
    :maxAcc<10
    ?`æœ€å¤§åŠ é€Ÿåº¦: ${maxAcc.toFixed(1)}G\n\nã‚¢ãƒãƒãƒ¥ã‚¢å¹³å‡ãƒ¬ãƒ™ãƒ«ã®ãƒ‘ãƒ¯ãƒ¼ã§ã™ã€‚ä¸‹åŠèº«ãƒªãƒ¼ãƒ‰ã‚’ã•ã‚‰ã«æ„è­˜ã™ã‚‹ã¨é£›è·é›¢ã‚¢ãƒƒãƒ—ãŒè¦‹è¾¼ã‚ã¾ã™ã€‚\n\nã€ç·´ç¿’æ³•ã€‘\n1. å³è¶³ã®è¹´ã‚Šã‚’æ„è­˜ã—ãŸãƒ‰ãƒªãƒ«\n2. å·¦è…°ã‚’å…ˆè¡Œã•ã›ã‚‹ã‚¤ãƒ¡ãƒ¼ã‚¸ã§ç´ æŒ¯ã‚Š\n3. ãƒ˜ãƒƒãƒ‰ã®é‡ã•ã‚’æ„Ÿã˜ã¦ãƒªãƒªãƒ¼ã‚¹`
    :`æœ€å¤§åŠ é€Ÿåº¦: ${maxAcc.toFixed(1)}G\n\nã—ã£ã‹ã‚Šã¨ã—ãŸåŠ é€ŸãŒå‡ºã¦ã„ã¾ã™ã€‚ãƒ‘ãƒ¯ãƒ¼ã¯ååˆ†ãªã®ã§ã€æ–¹å‘æ€§ã®å®‰å®šã«æ³¨åŠ›ã—ã¾ã—ã‚‡ã†ã€‚\n\nã€ãƒã‚¤ãƒ³ãƒˆã€‘ãƒ‘ãƒ¯ãƒ¼ãŒã‚ã‚‹åˆ†ã€ãƒ†ãƒ³ãƒãŒé€Ÿããªã‚ŠãŒã¡ã§ã™ã€‚8å‰²ã®åŠ›æ„Ÿã§æŒ¯ã‚‹ã“ã¨ã§å®‰å®šæ€§ãŒä¸ŠãŒã‚Šã¾ã™ã€‚`;

  details.rotation=maxGyro<20
    ?`æœ€å¤§è§’é€Ÿåº¦: ${maxGyro.toFixed(1)} rad/s\n\nä½“ã®å›è»¢ãŒæµ…ãã€æ‰‹ã ã‘ã§ã‚¹ã‚¤ãƒ³ã‚°ã—ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚\n\nã€ç·´ç¿’æ³•ã€‘\n1. ãƒãƒƒã‚¯ã‚¹ã‚¤ãƒ³ã‚°ã§å·¦è‚©ã‚’ã‚ã”ã®ä¸‹ã¾ã§å›ã™\n2. èƒ¸ã®å‘ãã‚’90åº¦ä»¥ä¸Šã‚¿ãƒ¼ãƒ³ã•ã›ã‚‹æ„è­˜\n3. ã‚¯ãƒ©ãƒ–ã‚’è‚©ã«ä¹—ã›ã¦å›è»¢ãƒ‰ãƒªãƒ«`
    :maxGyro<35
    ?`æœ€å¤§è§’é€Ÿåº¦: ${maxGyro.toFixed(1)} rad/s\n\nå›è»¢ã¯ã‚ã‚Šã¾ã™ãŒã€ã‚‚ã†å°‘ã—æ»è»¢å·®ã‚’ä½œã‚‹ã¨é£›è·é›¢ãŒä¼¸ã³ã¾ã™ã€‚\n\nã€ç·´ç¿’æ³•ã€‘\n1. ä¸‹åŠèº«ã‚’å›ºå®šã—ã¦ä¸Šä½“ã ã‘å›ã™ç´ æŒ¯ã‚Š\n2. å·¦è¶³ã®ã¤ã¾å…ˆã‚’å°‘ã—é–‹ã„ã¦ãƒ•ã‚©ãƒ­ãƒ¼ã®å›è»¢ã‚’å¤§ãã`
    :`æœ€å¤§è§’é€Ÿåº¦: ${maxGyro.toFixed(1)} rad/s\n\nååˆ†ãªå›è»¢é€Ÿåº¦ãŒå‡ºã¦ã„ã¾ã™ã€‚ã“ã‚Œä»¥ä¸Šã®å›è»¢ã‚’æ±‚ã‚ã‚‹ã‚ˆã‚Šã€å›è»¢è»¸ã®å®‰å®šã‚’æ„è­˜ã—ã¾ã—ã‚‡ã†ã€‚`;

  details.release=releaseOffset<-50
    ?`ãƒªãƒªãƒ¼ã‚¹ã‚ªãƒ•ã‚»ãƒƒãƒˆ: ${releaseOffset.toFixed(0)}msï¼ˆã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆã‚ˆã‚Š${Math.abs(releaseOffset).toFixed(0)}msæ—©ã„ï¼‰\n\nãƒ€ã‚¦ãƒ³ã‚¹ã‚¤ãƒ³ã‚°ã®æ—©ã„æ®µéšã§æ‰‹é¦–ãŒè§£ã‘ã¦ã„ã¾ã™ï¼ˆã‚­ãƒ£ã‚¹ãƒ†ã‚£ãƒ³ã‚°ï¼‰ã€‚ãƒ‘ãƒ¯ãƒ¼ãƒ­ã‚¹ã¨ã‚¹ãƒ©ã‚¤ã‚¹ã®åŸå› ã«ãªã‚Šã¾ã™ã€‚\n\nã€ç·´ç¿’æ³•ã€‘\n1. å³æ‰‹ã®è¦ªæŒ‡ã§ã‚·ãƒ£ãƒ•ãƒˆã‚’æŠ¼ã•ãˆã‚‹æ„Ÿè¦šã‚’ä¿ã¤\n2. ãƒ€ã‚¦ãƒ³ã‚¹ã‚¤ãƒ³ã‚°ã§ã‚°ãƒªãƒƒãƒ—ã‚¨ãƒ³ãƒ‰ã‚’ãƒœãƒ¼ãƒ«ã«å‘ã‘ã‚‹æ„è­˜\n3. ãƒ‘ãƒ³ãƒã‚·ãƒ§ãƒƒãƒˆãƒ‰ãƒªãƒ«`
    :releaseOffset>50
    ?`ãƒªãƒªãƒ¼ã‚¹ã‚ªãƒ•ã‚»ãƒƒãƒˆ: ${releaseOffset.toFixed(0)}msï¼ˆã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆã‚ˆã‚Š${releaseOffset.toFixed(0)}msé…ã„ï¼‰\n\nãƒªãƒªãƒ¼ã‚¹ãŒé…ã™ãã¦ã€ãƒ•ã‚§ãƒ¼ã‚¹ãŒé–‹ã„ãŸã¾ã¾ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆã—ã¦ã„ã¾ã™ã€‚ãƒ—ãƒƒã‚·ãƒ¥ã‚¢ã‚¦ãƒˆã®åŸå› ã«ãªã‚Šã¾ã™ã€‚\n\nã€ç·´ç¿’æ³•ã€‘\n1. å·¦æ‰‹ã®ç”²ã‚’åœ°é¢ã«å‘ã‘ã‚‹ã‚¤ãƒ¡ãƒ¼ã‚¸ã§ãƒªãƒªãƒ¼ã‚¹\n2. 9æ™‚ã€œ3æ™‚ã®æŒ¯ã‚Šå¹…ã§ãƒªãƒªãƒ¼ã‚¹æ„Ÿã‚’ç·´ç¿’`
    :`ãƒªãƒªãƒ¼ã‚¹ã‚ªãƒ•ã‚»ãƒƒãƒˆ: ${releaseOffset.toFixed(0)}ms\n\nã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆä»˜è¿‘ã§æ­£ã—ããƒªãƒªãƒ¼ã‚¹ã§ãã¦ã„ã¾ã™ã€‚æ‰‹é¦–ã®ã‚¿ãƒ¡ã¨è§£æ”¾ã®ãƒãƒ©ãƒ³ã‚¹ãŒè‰¯å¥½ã§ã™ã€‚\n\nã€ãƒã‚¤ãƒ³ãƒˆã€‘ã“ã®æ„Ÿè¦šã‚’å†ç¾ã§ãã‚‹ã‚ˆã†ã€9æ™‚ã€œ3æ™‚ã®ãƒãƒ¼ãƒ•ã‚·ãƒ§ãƒƒãƒˆã§ãƒªãƒªãƒ¼ã‚¹æ„Ÿã‚’ä½“ã«è¦šãˆã•ã›ã¾ã—ã‚‡ã†ã€‚`;

  details.smoothness=scores.smoothness<50
    ?`ã‚¸ãƒ£ãƒ¼ã‚¯æŒ‡æ¨™: ${avgJerk.toFixed(1)}\n\nåŠ é€Ÿåº¦ã®å¤‰åŒ–ãŒæ€¥æ¿€ã§ã€ã‚¹ã‚¤ãƒ³ã‚°ã«ã€Œã‚¬ã‚¯ãƒƒã€ã¨ã—ãŸå‹•ããŒã‚ã‚Šã¾ã™ã€‚åŠ›ã¿ãŒåŸå› ã®å¯èƒ½æ€§ãŒé«˜ã„ã§ã™ã€‚\n\nã€ç·´ç¿’æ³•ã€‘\n1. ã‚°ãƒªãƒƒãƒ—ãƒ—ãƒ¬ãƒƒã‚·ãƒ£ãƒ¼ã‚’10æ®µéšã®4ç¨‹åº¦ã«\n2. é€£ç¶šç´ æŒ¯ã‚Šã§æ»‘ã‚‰ã‹ãªãƒªã‚ºãƒ ã‚’ä½œã‚‹\n3. ç›®ã‚’é–‰ã˜ã¦ç´ æŒ¯ã‚Šã—ã€ä½“ã®å‹•ãã«é›†ä¸­`
    :scores.smoothness<75
    ?`ã‚¸ãƒ£ãƒ¼ã‚¯æŒ‡æ¨™: ${avgJerk.toFixed(1)}\n\næ¦‚ã­ã‚¹ãƒ ãƒ¼ã‚ºã§ã™ãŒã€åˆ‡ã‚Šè¿”ã—ä»˜è¿‘ã§ã‚„ã‚„æ€¥ãªå‹•ããŒã‚ã‚Šã¾ã™ã€‚\n\nã€ç·´ç¿’æ³•ã€‘åˆ‡ã‚Šè¿”ã—ã§ä¸€ç¬ã€Œé–“ã€ã‚’ä½œã‚‹æ„è­˜ã€‚ãƒˆãƒƒãƒ—ã§0.1ç§’ã ã‘å¾…ã¤ã‚¤ãƒ¡ãƒ¼ã‚¸ãŒæœ‰åŠ¹ã§ã™ã€‚`
    :`ã‚¸ãƒ£ãƒ¼ã‚¯æŒ‡æ¨™: ${avgJerk.toFixed(1)}\n\nã¨ã¦ã‚‚æ»‘ã‚‰ã‹ãªã‚¹ã‚¤ãƒ³ã‚°ã§ã™ã€‚åŠ é€Ÿåº¦ã®å¤‰åŒ–ãŒç©ã‚„ã‹ã§ã€åŠ¹ç‡çš„ã«ã‚¨ãƒãƒ«ã‚®ãƒ¼ã‚’ä¼ãˆã‚‰ã‚Œã¦ã„ã¾ã™ã€‚`;

  details.followthrough=scores.followthrough<50
    ?`ãƒ•ã‚©ãƒ­ãƒ¼ã‚¹ãƒ«ãƒ¼å¹³å‡åŠ é€Ÿåº¦: ${avgPostImp.toFixed(2)}G\n\nã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆå¾Œã«æ€¥æ¸›é€Ÿã—ã¦ã„ã¾ã™ã€‚ãƒœãƒ¼ãƒ«ã‚’ã€Œæ‰“ã£ã¦çµ‚ã‚ã‚Šã€ã§ã¯ãªãã€ã€ŒæŒ¯ã‚ŠæŠœãã€æ„è­˜ãŒå¿…è¦ã§ã™ã€‚\n\nã€ç·´ç¿’æ³•ã€‘\n1. ãƒ•ã‚£ãƒ‹ãƒƒã‚·ãƒ¥ã§3ç§’é–“é™æ­¢ã™ã‚‹ãƒ‰ãƒªãƒ«\n2. å·¦è‚©ã®ä¸Šã«ã‚¯ãƒ©ãƒ–ãŒåã¾ã‚‹ãƒ•ã‚£ãƒ‹ãƒƒã‚·ãƒ¥ã‚’æ„è­˜\n3. ç›®æ¨™ã®å…ˆã«æŒ¯ã‚ŠæŠœãã‚¤ãƒ¡ãƒ¼ã‚¸`
    :`ãƒ•ã‚©ãƒ­ãƒ¼ã‚¹ãƒ«ãƒ¼å¹³å‡åŠ é€Ÿåº¦: ${avgPostImp.toFixed(2)}G\n\nã—ã£ã‹ã‚ŠæŒ¯ã‚ŠæŠœã‘ã¦ã„ã¾ã™ã€‚ãƒ•ã‚©ãƒ­ãƒ¼ã‚¹ãƒ«ãƒ¼ãŒå¤§ãã„ã¨ã€ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆã‚¾ãƒ¼ãƒ³ãŒé•·ããªã‚Šæ–¹å‘æ€§ã‚‚å®‰å®šã—ã¾ã™ã€‚`;
  
  const labels={tempo:'ãƒ†ãƒ³ãƒ',power:'ãƒ‘ãƒ¯ãƒ¼',rotation:'å›è»¢é€Ÿåº¦',release:'ãƒªãƒªãƒ¼ã‚¹',smoothness:'ã‚¹ãƒ ãƒ¼ã‚ºã•',followthrough:'ãƒ•ã‚©ãƒ­ãƒ¼ã‚¹ãƒ«ãƒ¼'};
  const colors={tempo:'var(--cy)',power:'var(--or)',rotation:'var(--pu)',release:'var(--g)',smoothness:'var(--bl)',followthrough:'var(--pk)'};
  
  lastAnalysis={scores,overall,tips,details,labels,colors,raw:{tempoRatio,maxAcc,maxGyro,releaseOffset,avgJerk,avgPostImp,dur,impTime}};
  return lastAnalysis;
}

function renderAdvice(){
  const a=analyzeSwing();if(!a)return;
  
  const ring=document.getElementById('advRing');
  ring.textContent=a.overall;
  ring.style.borderColor=a.overall>=80?'var(--g)':a.overall>=60?'var(--or)':'var(--rd)';
  ring.style.color=a.overall>=80?'var(--g)':a.overall>=60?'var(--or)':'var(--rd)';
  
  const grade=a.overall>=90?'Excellent!':a.overall>=80?'Great!':a.overall>=70?'Good':a.overall>=60?'Fair':a.overall>=50?'Needs Work':'Practice More';
  document.getElementById('advGrade').textContent=grade;
  document.getElementById('advSummary').textContent=`ãƒ†ãƒ³ãƒæ¯” ${a.raw.tempoRatio.toFixed(1)}:1 / æœ€å¤§${a.raw.maxAcc.toFixed(1)}G / ${a.raw.dur.toFixed(1)}ç§’`;
  
  const cont=document.getElementById('advItems');
  cont.innerHTML='';
  Object.keys(a.scores).forEach(k=>{
    const sc=a.scores[k];
    const cls=sc>=75?'s-good':sc>=50?'s-ok':'s-bad';
    const detailText=(a.details[k]||'').replace(/\n/g,'<br>');
    cont.innerHTML+=`<div class="adv-item" onclick="this.querySelector('.adv-detail').classList.toggle('open')">
      <div class="adv-item-h"><span class="adv-item-n">${a.labels[k]}</span><span class="adv-item-s ${cls}">${sc}/100</span></div>
      <div class="adv-bar"><div class="adv-bar-f" style="width:${sc}%;background:${a.colors[k]}"></div></div>
      <div class="adv-tip">${a.tips[k]}</div>
      <div class="adv-detail"><div class="adv-detail-inner">${detailText}</div></div>
    </div>`;
  });
  
  document.getElementById('aiRes').style.display='none';
  document.getElementById('aiBtn').disabled=false;
  drawRadar(a);
}

function drawRadar(a){
  const wrap=document.getElementById('radarWrap');
  wrap.style.display='';
  const cv=document.getElementById('radarCv');
  const pr=devicePixelRatio||1;
  const size=Math.min(300,wrap.clientWidth-28);
  cv.width=size*pr;cv.height=size*pr;
  cv.style.width=size+'px';cv.style.height=size+'px';
  const cx=cv.getContext('2d');
  cx.scale(pr,pr);
  
  const keys=Object.keys(a.scores);
  const n=keys.length;
  const centerX=size/2, centerY=size/2;
  const radius=size/2-44;
  const angleStep=Math.PI*2/n;
  const startAngle=-Math.PI/2;
  
  function pt(i,val){
    const ang=startAngle+angleStep*i;
    const r=radius*val/100;
    return {x:centerX+Math.cos(ang)*r, y:centerY+Math.sin(ang)*r};
  }
  
  cx.clearRect(0,0,size,size);
  
  // Grid rings
  [20,40,60,80,100].forEach(v=>{
    cx.beginPath();
    for(let i=0;i<=n;i++){
      const p=pt(i%n,v);
      i===0?cx.moveTo(p.x,p.y):cx.lineTo(p.x,p.y);
    }
    cx.closePath();
    cx.strokeStyle=v===60?'rgba(255,255,255,.25)':'rgba(255,255,255,.12)';
    cx.lineWidth=v===60?1.2:.7;
    cx.stroke();
  });
  
  // Axis lines
  for(let i=0;i<n;i++){
    const p=pt(i,100);
    cx.beginPath();cx.moveTo(centerX,centerY);cx.lineTo(p.x,p.y);
    cx.strokeStyle='rgba(255,255,255,.1)';cx.lineWidth=.7;cx.stroke();
  }
  
  // Data fill
  cx.beginPath();
  keys.forEach((k,i)=>{
    const p=pt(i,a.scores[k]);
    i===0?cx.moveTo(p.x,p.y):cx.lineTo(p.x,p.y);
  });
  cx.closePath();
  cx.fillStyle='rgba(34,217,127,.12)';cx.fill();
  cx.strokeStyle='rgba(34,217,127,.6)';cx.lineWidth=2;cx.stroke();
  
  // Resolve CSS variable colors to hex for canvas
  const colorHex={tempo:'#06b6d4',power:'#f59e0b',rotation:'#a855f7',release:'#22d97f',smoothness:'#3b82f6',followthrough:'#ec4899'};
  function scColor(sc){return sc>=75?'#22d97f':sc>=50?'#f59e0b':'#ef4444'}
  
  // Data points (larger for tap target)
  const hitAreas=[];
  keys.forEach((k,i)=>{
    const p=pt(i,a.scores[k]);
    cx.beginPath();cx.arc(p.x,p.y,6,0,Math.PI*2);
    cx.fillStyle=scColor(a.scores[k]);
    cx.fill();
    cx.strokeStyle='rgba(0,0,0,.4)';cx.lineWidth=1.5;cx.stroke();
    cx.beginPath();cx.arc(p.x,p.y-1,2,0,Math.PI*2);
    cx.fillStyle='rgba(255,255,255,.35)';cx.fill();
    hitAreas.push({x:p.x,y:p.y,idx:i,key:k});
  });
  
  // Labels
  cx.textAlign='center';cx.textBaseline='middle';
  keys.forEach((k,i)=>{
    const ang=startAngle+angleStep*i;
    const labelR=radius+28;
    const lx=centerX+Math.cos(ang)*labelR;
    const ly=centerY+Math.sin(ang)*labelR;
    cx.font='600 11px Outfit,sans-serif';
    cx.fillStyle=colorHex[k];
    cx.fillText(a.labels[k],lx,ly-7);
    cx.font='700 12px JetBrains Mono,monospace';
    cx.fillStyle=scColor(a.scores[k]);
    cx.fillText(a.scores[k],lx,ly+8);
  });
  
  // Store hit areas for click handling
  cv._hitAreas=hitAreas;
  cv._pr=pr;
}

// Radar click/touch handler
function handleRadarTap(e){
  const cv=document.getElementById('radarCv');
  if(!cv._hitAreas)return;
  const rect=cv.getBoundingClientRect();
  let clientX,clientY;
  if(e.touches){clientX=e.touches[0].clientX;clientY=e.touches[0].clientY;e.preventDefault()}
  else{clientX=e.clientX;clientY=e.clientY}
  const x=clientX-rect.left;
  const y=clientY-rect.top;
  const tapRadius=28;
  for(const h of cv._hitAreas){
    const dx=x-h.x, dy=y-h.y;
    if(dx*dx+dy*dy<=tapRadius*tapRadius){
      document.querySelectorAll('.adv-detail').forEach(d=>d.classList.remove('open'));
      const items=document.querySelectorAll('.adv-item');
      if(items[h.idx]){
        const detail=items[h.idx].querySelector('.adv-detail');
        if(detail)detail.classList.add('open');
        items[h.idx].scrollIntoView({behavior:'smooth',block:'center'});
      }
      break;
    }
  }
}
document.getElementById('radarCv').addEventListener('click',handleRadarTap);
document.getElementById('radarCv').addEventListener('touchstart',handleRadarTap,{passive:false});

// ===================== CLAUDE AI ADVICE =====================
async function askAI(){
  if(!lastAnalysis)return;
  const btn=document.getElementById('aiBtn');
  const res=document.getElementById('aiRes');
  btn.disabled=true;btn.textContent='åˆ†æä¸­...';
  res.style.display='';res.textContent='AIãŒã‚¹ã‚¤ãƒ³ã‚°ã‚’åˆ†æã—ã¦ã„ã¾ã™...';
  
  const a=lastAnalysis;
  const prompt=`ã‚ãªãŸã¯ãƒ—ãƒ­ã‚´ãƒ«ãƒ•ã‚³ãƒ¼ãƒã§ã™ã€‚ä»¥ä¸‹ã®Apple Watchã‚»ãƒ³ã‚µãƒ¼ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å–å¾—ã—ãŸã‚´ãƒ«ãƒ•ã‚¹ã‚¤ãƒ³ã‚°åˆ†æçµæœã«åŸºã¥ã„ã¦ã€å…·ä½“çš„ã§å®Ÿè·µçš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’æ—¥æœ¬èªã§æä¾›ã—ã¦ãã ã•ã„ã€‚

ã€ã‚¹ã‚¤ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ã€‘
- ã‚¹ã‚¤ãƒ³ã‚°æ™‚é–“: ${a.raw.dur.toFixed(2)}ç§’
- ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆæ™‚åˆ»: ${a.raw.impTime.toFixed(3)}ç§’
- ãƒ†ãƒ³ãƒæ¯”ï¼ˆãƒ†ã‚¤ã‚¯ãƒãƒƒã‚¯:ãƒ€ã‚¦ãƒ³ã‚¹ã‚¤ãƒ³ã‚°ï¼‰: ${a.raw.tempoRatio.toFixed(2)}:1
- æœ€å¤§åŠ é€Ÿåº¦: ${a.raw.maxAcc.toFixed(1)}G
- æœ€å¤§è§’é€Ÿåº¦: ${a.raw.maxGyro.toFixed(1)} rad/s
- ãƒªãƒªãƒ¼ã‚¹ã‚ªãƒ•ã‚»ãƒƒãƒˆ: ${a.raw.releaseOffset.toFixed(0)}msï¼ˆè² =æ—©ã„ã€æ­£=é…ã„ï¼‰
- å¹³å‡ã‚¸ãƒ£ãƒ¼ã‚¯: ${a.raw.avgJerk.toFixed(1)}
- ãƒ•ã‚©ãƒ­ãƒ¼ã‚¹ãƒ«ãƒ¼å¹³å‡åŠ é€Ÿåº¦: ${a.raw.avgPostImp.toFixed(2)}G

ã€ã‚¹ã‚³ã‚¢ã€‘
${Object.keys(a.scores).map(k=>`- ${a.labels[k]}: ${a.scores[k]}/100`).join('\n')}
- ç·åˆ: ${a.overall}/100

ä»¥ä¸‹ã®å½¢å¼ã§å›ç­”ã—ã¦ãã ã•ã„:
1. ç·åˆè©•ä¾¡ï¼ˆ2-3æ–‡ï¼‰
2. è‰¯ã„ç‚¹ï¼ˆ2-3ã¤ï¼‰
3. æ”¹å–„ãƒã‚¤ãƒ³ãƒˆï¼ˆæœ€ã‚‚é‡è¦ãª2-3ã¤ã€å…·ä½“çš„ãªç·´ç¿’æ–¹æ³•ä»˜ãï¼‰
4. æ¬¡å›ã®ç·´ç¿’ã§æ„è­˜ã™ã¹ãã“ã¨ï¼ˆ1ã¤ã«çµã‚‹ï¼‰

ç°¡æ½”ã«å›ç­”ã—ã¦ãã ã•ã„ã€‚`;

  try{
    const response=await fetch('https://api.anthropic.com/v1/messages',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({model:'claude-sonnet-4-20250514',max_tokens:1000,messages:[{role:'user',content:prompt}]})
    });
    const data=await response.json();
    const text=data.content?.map(c=>c.text||'').join('\n')||'å¿œç­”ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ';
    res.textContent=text;
  }catch(e){
    res.textContent='ã‚¨ãƒ©ãƒ¼: '+e.message;
  }
  btn.textContent='\u{1F916} AIã«è©³ç´°ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’èã';btn.disabled=false;
}
</script>
<script>if('serviceWorker' in navigator){navigator.serviceWorker.register('sw.js')}</script>
</body>
</html>
